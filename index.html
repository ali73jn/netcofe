<!-- index.html - Single-file React app for bookmark dashboard
     Code is in English. UI text and instructions in Persian will be provided in chat.
     Uses React (UMD), Babel, interact.js for drag/resize.
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cafe Dashboard - Bookmarks</title>
  <style>
    /* Basic reset */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body,#root{height:100%}
    body{font-family:Inter, system-ui, sans-serif;background:#f2f6fb;color:#0f172a}

    /* Top bar */
    .topbar{height:64px;display:flex;align-items:center;gap:12px;padding:0 16px;background:rgba(255,255,255,0.6);backdrop-filter:blur(6px);box-shadow:0 2px 6px rgba(15,23,42,0.06)}
    .topbar .left{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 10px;border-radius:8px;background:transparent;border:1px solid rgba(15,23,42,0.06);cursor:pointer}
    .icon{width:20px;height:20px;display:inline-block}
    .search{margin-left:8px;padding:6px 8px;border-radius:8px;border:1px solid rgba(15,23,42,0.08);min-width:220px}

    /* Main area */
    .app{display:flex;flex-direction:column;height:calc(100% - 64px)}
    .stage{flex:1;position:relative;padding:16px;overflow:auto}
    .grid{position:relative;width:100%;min-height:400px;background-image:linear-gradient(90deg, rgba(0,0,0,0.02) 1px, transparent 1px), linear-gradient(0deg, rgba(0,0,0,0.02) 1px, transparent 1px);background-size:120px 120px;}

    /* Card style (glassmorphism) */
    .card{position:absolute;border-radius:12px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.55));box-shadow:0 6px 18px rgba(15,23,42,0.08);border:1px solid rgba(255,255,255,0.5);backdrop-filter: blur(6px);overflow:hidden}
    .card .header{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .card .title{font-weight:600;font-size:14px;display:flex;align-items:center;gap:8px}
    .card .actions{display:flex;gap:6px}
    .small{font-size:12px;padding:6px;border-radius:8px}
    .bookmark-list{margin-top:8px;display:flex;flex-direction:column;gap:6px;max-height:240px;overflow:auto}
    .bookmark{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px;background:rgba(255,255,255,0.45);cursor:pointer}
    .bookmark img{width:28px;height:28px;border-radius:6px}
    .popup{position:fixed;padding:8px 10px;border-radius:8px;background:#0f172a;color:#fff;z-index:9999;box-shadow:0 8px 24px rgba(2,6,23,0.6)}

    /* Resize handles (small squares) */
    .handle{width:10px;height:10px;background:rgba(15,23,42,0.12);position:absolute;border-radius:3px}
    .handle.br{right:6px;bottom:6px;cursor:se-resize}

    /* Search results */
    .search-results{position:absolute;top:64px;left:16px;background:#fff;border-radius:8px;box-shadow:0 10px 30px rgba(2,6,23,0.08);max-height:320px;overflow:auto;padding:8px;min-width:300px;z-index:40}
    .sr-item{padding:8px;border-bottom:1px solid rgba(0,0,0,0.04);cursor:pointer}

    /* Minimal responsiveness */
    @media(max-width:720px){.search{min-width:120px}}
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- Dependencies: React UMD, ReactDOM UMD, Babel for JSX, interact.js for drag/resize -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/interactjs/dist/interact.min.js"></script>
  <script src="https://unpkg.com/uuid@9.0.0/dist/umd/uuidv4.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <script type="text/babel">
  const {useState,useEffect,useRef} = React;
  const {v4: uuidv4} = uuid;

  // Utility: get favicon by site URL
  function faviconFor(url){
    try{
      const u = new URL(url);
      return `https://www.google.com/s2/favicons?domain=${u.hostname}`;
    }catch(e){
      return '';
    }
  }

  // Default demo data
  const defaultData = {
    settings:{background:'',gridSize:120},
    cards:[
      {id:uuidv4(),name:'Favorites',x:20,y:20,w:360,h:220,bookmarks:[
        {id:uuidv4(),name:'Google',url:'https://www.google.com',desc:'Search engine',icon:faviconFor('https://www.google.com')},
        {id:uuidv4(),name:'MDN',url:'https://developer.mozilla.org',desc:'Docs',icon:faviconFor('https://developer.mozilla.org')}
      ]}
    ]
  };

  function useLocalStorageState(key, initial){
    const [state,setState] = useState(()=>{
      try{const s = localStorage.getItem(key); return s?JSON.parse(s):initial}catch(e){return initial}
    });
    useEffect(()=>{localStorage.setItem(key,JSON.stringify(state));},[key,state]);
    return [state,setState];
  }

  function App(){
    const [data,setData] = useLocalStorageState('cafe:data', defaultData);
    const [editMode,setEditMode] = useLocalStorageState('cafe:edit', false);
    const [searchTerm,setSearchTerm] = useState('');
    const [searchResults,setSearchResults] = useState([]);
    const stageRef = useRef(null);
    const popupRef = useRef({timeout:null,el:null});

    // Initialize interact for existing cards when rendered
    useEffect(()=>{
      // cleanup previous interactions
      interact('.draggable').unset();

      data.cards.forEach(card=>{
        const selector = `#card-${card.id}`;

        interact(selector)
          .draggable({enabled:editMode, listeners:{move(event){
              const id = event.target.dataset.id;
              const dx = event.dx; const dy = event.dy;
              setData(prev=>{
                const clone = JSON.parse(JSON.stringify(prev));
                const c = clone.cards.find(x=>x.id===id);
                if(c){ c.x = Math.max(0, c.x + dx); c.y = Math.max(0, c.y + dy); }
                return clone;
              });
          }}})
          .resizable({edges:{bottom:true,right:true},enabled:editMode,listeners:{move(event){
              const id = event.target.dataset.id;
              const dw = event.deltaRect.width; const dh = event.deltaRect.height;
              setData(prev=>{
                const clone = JSON.parse(JSON.stringify(prev));
                const c = clone.cards.find(x=>x.id===id);
                if(c){ c.w = Math.max(120, c.w + dw); c.h = Math.max(80, c.h + dh); }
                return clone;
              });
          }}});
      });
    },[data.cards.length, editMode]);

    // Search
    useEffect(()=>{
      if(!searchTerm) return setSearchResults([]);
      const q = searchTerm.toLowerCase();
      const results = [];
      data.cards.forEach(card=>{
        card.bookmarks?.forEach(b=>{
          if((b.name||'').toLowerCase().includes(q) || (b.desc||'').toLowerCase().includes(q)){
            results.push({cardId:card.id,bookmark:b});
          }
        });
      });
      setSearchResults(results);
    },[searchTerm,data]);

    // Add card
    function addCard(){
      const newCard = {id:uuidv4(),name:'New Card',x:20,y:20,w:300,h:180,bookmarks:[]};
      setData(prev=>({...prev, cards:[...prev.cards,newCard]}));
    }

    // Add bookmark to a card
    function addBookmark(cardId){
      const url = prompt('Bookmark URL (full):');
      if(!url) return; const name = prompt('Name for bookmark:', url.replace(/^https?:\/\//,'')) || url;
      const desc = prompt('Description (optional):','') || '';
      const bm = {id:uuidv4(),name, url, desc, icon: faviconFor(url)};
      setData(prev=>{
        const clone = JSON.parse(JSON.stringify(prev));
        const card = clone.cards.find(c=>c.id===cardId);
        card.bookmarks.push(bm);
        return clone;
      });
    }

    // Add folder (implemented as a nested bookmark with type folder flag)
    function addFolder(cardId){
      const name = prompt('Folder name:','New Folder');
      if(!name) return;
      const folder = {id:uuidv4(),name,folder:true,bookmarks:[]};
      setData(prev=>{
        const clone = JSON.parse(JSON.stringify(prev));
        const card = clone.cards.find(c=>c.id===cardId);
        card.bookmarks.push(folder);
        return clone;
      });
    }

    function renameCard(cardId){
      const name = prompt('New card name:'); if(name==null) return;
      setData(prev=>{const clone=JSON.parse(JSON.stringify(prev));const c=clone.cards.find(x=>x.id===cardId);if(c) c.name=name;return clone;});
    }

    function deleteCard(cardId){ if(!confirm('Delete this card?')) return; setData(prev=>({...prev,cards:prev.cards.filter(x=>x.id!==cardId)})); }

    function deleteBookmark(cardId,bmId){ if(!confirm('Delete this bookmark?')) return; setData(prev=>{const clone=JSON.parse(JSON.stringify(prev));const c=clone.cards.find(x=>x.id===cardId); if(c) c.bookmarks = c.bookmarks.filter(b=>b.id!==bmId); return clone;}); }

    function editBookmark(cardId,bm){
      const name = prompt('Name:', bm.name); if(name==null) return; const url = prompt('URL:', bm.url); if(url==null) return; const desc = prompt('Description:', bm.desc || '');
      setData(prev=>{const clone=JSON.parse(JSON.stringify(prev)); const c=clone.cards.find(x=>x.id===cardId); const b=c.bookmarks.find(x=>x.id===bm.id); b.name=name; b.url=url; b.desc=desc; b.icon=faviconFor(url); return clone;});
    }

    // Download DB
    function downloadDB(){
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const ts = new Date().toISOString().replaceAll(':','-').replaceAll('.','-');
      const name = `cafe-data-${ts}.json`;
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // Upload DB
    function uploadDB(file){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        try{
          const parsed = JSON.parse(e.target.result);
          if(!confirm('Apply uploaded database and replace current layout?')) return;
          setData(parsed);
        }catch(er){alert('Invalid JSON file');}
      };
      reader.readAsText(file);
    }

    // Hover popup for bookmark (1s hold)
    function startHover(e, bookmark){
      const el = e.currentTarget;
      popupRef.current.timeout = setTimeout(()=>{
        const r = el.getBoundingClientRect();
        const popup = document.createElement('div'); popup.className='popup'; popup.innerText = bookmark.desc || '(no description)';
        document.body.appendChild(popup);
        popup.style.left = (r.right + 8) + 'px'; popup.style.top = (r.top) + 'px'; popupRef.current.el = popup;
      }, 900);
    }
    function cancelHover(){ clearTimeout(popupRef.current.timeout); if(popupRef.current.el){ popupRef.current.el.remove(); popupRef.current.el = null; } }

    return (
      <div className="container">
        <div className="topbar">
          <div className="left">
            <button className="btn" onClick={()=>setEditMode(m=>!m)}>{editMode? 'Exit Edit':'Edit'}</button>
            <button className="btn" onClick={addCard}>+</button>
            <button className="btn" onClick={downloadDB}>Database</button>
            <input className="search" placeholder="Search bookmarks..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
            <input type="file" style={{display:'none'}} id="upload-db" onChange={e=>uploadDB(e.target.files[0])} />
          </div>
          <div style={{marginLeft:'auto'}}>
            <button className="btn" onClick={()=>{document.getElementById('upload-db').click();}}>Upload DB</button>
            <button className="btn" onClick={()=>{localStorage.removeItem('cafe:data'); location.reload();}}>Reset</button>
          </div>
        </div>

        <div className="app">
          <div className="stage" ref={stageRef}>
            {searchResults.length>0 && (
              <div className="search-results">
                {searchResults.map(r=> (
                  <div key={r.bookmark.id} className="sr-item" onClick={()=>{ alert(`Go to ${r.bookmark.url}`); }}>
                    <div style={{fontWeight:600}}>{r.bookmark.name}</div>
                    <div style={{fontSize:12,color:'#475569'}}>{r.bookmark.url}</div>
                  </div>
                ))}
              </div>
            )}

            <div className="grid">
              {data.cards.map(card=> (
                <div key={card.id} id={`card-${card.id}`} data-id={card.id} className={`card draggable`} style={{left:card.x+'px', top:card.y+'px', width:card.w+'px', height:card.h+'px'}}>
                  <div className="header">
                    <div className="title">{card.name}</div>
                    <div className="actions">
                      <button className="small" onClick={()=>renameCard(card.id)}>Rename</button>
                      <button className="small" onClick={()=>addBookmark(card.id)}>+BM</button>
                      <button className="small" onClick={()=>addFolder(card.id)}>+Folder</button>
                      <button className="small" onClick={()=>deleteCard(card.id)}>Delete</button>
                    </div>
                  </div>

                  <div className="bookmark-list">
                    {card.bookmarks.map(b=> (
                      <div key={b.id} className="bookmark" onMouseDown={(e)=>{}} onMouseEnter={(e)=>startHover(e,b)} onMouseLeave={cancelHover} onClick={()=>{ if(b.folder){ const newName = prompt('Open folder - rename? (cancel to keep) ', b.name); if(newName) setData(prev=>{ const clone=JSON.parse(JSON.stringify(prev)); const c=clone.cards.find(x=>x.id===card.id); const bi=c.bookmarks.find(x=>x.id===b.id); bi.name=newName; return clone; }); } else { window.open(b.url,'_blank'); } }}>
                        {b.icon ? <img src={b.icon} alt="icon"/> : <div style={{width:28,height:28,background:'#e2e8f0'}}/>}
                        <div style={{flex:1}}>
                          <div style={{fontSize:13,fontWeight:600}}>{b.name}</div>
                          <div style={{fontSize:12,color:'#475569'}}>{b.url || (b.folder? 'Folder' : '')}</div>
                        </div>
                        <div style={{display:'flex',gap:6}}>
                          {!b.folder && <button className="small" onClick={(e)=>{e.stopPropagation(); editBookmark(card.id,b);}}>Edit</button>}
                          <button className="small" onClick={(e)=>{e.stopPropagation(); deleteBookmark(card.id,b.id);}}>Del</button>
                        </div>
                      </div>
                    ))}
                  </div>

                  {editMode && <div className="handle br" />}
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
